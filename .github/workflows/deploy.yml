name: Deploy mon_saas

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

      # 1Ô∏è‚É£ Checkout du code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Setup SSH
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.VPS_KEY }}

      # 3Ô∏è‚É£ Deploy sur VPS
      - name: Deploy to VPS
        run: |
          ssh -o StrictHostKeyChecking=no \
          -p ${{ secrets.VPS_PORT }} \
          ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'

            echo "üöÄ D√©ploiement en cours..."

            cd /opt/mon_saas || exit 1

            echo "üì• Reset & Pull"
            git reset --hard
            git clean -fd
            git pull origin master

            echo "üê≥ Build & Start containers"
            docker-compose up -d --build

            echo "‚è≥ Attente d√©marrage Django..."
            sleep 15

            echo "üì¶ Migration base de donn√©es"
            docker-compose exec -T django python manage.py migrate

            echo "üóÇ Collect static"
            docker-compose exec -T django python manage.py collectstatic --noinput

            echo "üßπ Nettoyage images inutilis√©es"
            docker image prune -f

            echo "üîç Containers actifs :"
            docker ps

            echo "‚úÖ D√©ploiement termin√© avec succ√®s"

          EOF